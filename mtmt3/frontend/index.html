<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<html lang="zh-CN">
<head>
  <title>在线转谱 Demo</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 40px auto; }
    .row { margin-bottom: 12px; }
    #log { white-space: pre-wrap; background: #f5f5f5; padding: 8px; min-height: 80px; }
  </style>
</head>
<body>
  <h1>在线转谱 Demo</h1>

  <div class="row">
    <input type="file" id="fileInput" title="请选择音频文件" placeholder="请选择音频文件" />
  </div>

  <div class="row">
    <label>模型：</label>
    <select id="model" title="选择模型"></select>
      <option value="mtmt3_piano_vocal">钢琴 + 人声</option>
      <option value="mtmt3_multi">多乐器</option>
    </select>
  </div>

  <div class="row">
    <label>音乐形式：</label>
    <select id="mode" title="选择音乐形式"></select>
      <option value="with_accompaniment">带伴奏演唱</option>
      <option value="a_cappella">无伴奏清唱</option>
      <option value="instrumental">纯乐器演奏</option>
    </select>
  </div>

  <div class="row">
    <label>量化：</label>
    <select id="quantization" title="选择量化精度"></select>
      <option value="none">无</option>
      <option value="1/4">1/4</option>
      <option value="1/8">1/8</option>
      <option value="1/16">1/16</option>
    </select>
  </div>

  <div class="row">
    <button id="uploadBtn">上传并转谱</button>
  </div>

  <div class="row">
    <div>当前 Task ID: <span id="taskId"></span></div>
    <div>状态: <span id="status"></span></div>
    <div>进度: <span id="progress"></span></div>
    <div id="downloadLinks"></div>
  </div>

  <div id="log"></div>

<script>
const API_BASE = "http://127.0.0.1:8000";

const $ = (id) => document.getElementById(id);

function log(msg) {
  $("log").textContent += msg + "\n";
}

$("uploadBtn").onclick = async () => {
  const file = $("fileInput").files[0];
  if (!file) {
    alert("先选个音频文件");
    return;
  }

  const form = new FormData();
  form.append("file", file);
  form.append("model", $("model").value);
  form.append("mode", $("mode").value);
  form.append("quantization", $("quantization").value);

  log("上传中...");

  const resp = await fetch(API_BASE + "/api/tasks", {
    method: "POST",
    body: form,
  });

  const data = await resp.json();
  log("创建任务: " + JSON.stringify(data));

  $("taskId").textContent = data.task_id;
  pollStatus(data.task_id);
};

async function pollStatus(taskId) {
  async function tick() {
    const resp = await fetch(API_BASE + "/api/tasks/" + taskId);
    const data = await resp.json();
    $("status").textContent = data.status;
    $("progress").textContent = (data.progress * 100).toFixed(0) + "%";

    if (data.status === "done" && data.result) {
      const d = data.result;
      $("downloadLinks").innerHTML =
        `<a href="${API_BASE + d.midi_url}" target="_blank">下载 MIDI</a> | ` +
        `<a href="${API_BASE + d.musicxml_url}" target="_blank">下载 MusicXML</a>`;
      log("任务完成");
    } else if (data.status === "failed") {
      log("任务失败: " + data.error_message);
    } else {
      setTimeout(tick, 3000);
    }
  }
  tick();
}
</script>

</body>
</html>
